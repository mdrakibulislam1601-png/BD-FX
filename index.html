<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BD-FX | Smart Investment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #0a0f1a; color: white; }
        .glass { background: rgba(22, 27, 42, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); }
        .pkg-card { transition: all 0.3s ease; border: 1px solid rgba(59, 130, 246, 0.1); }
        .pkg-card:hover { border-color: rgba(59, 130, 246, 0.5); transform: translateY(-5px); }
    </style>
</head>
<body>

    <nav class="p-6 border-b border-gray-800 flex justify-between items-center sticky top-0 z-50 bg-[#0a0f1a]/90 backdrop-blur-md">
        <div class="text-xl font-black italic tracking-tighter text-blue-500">BD-FX</div>
        <div class="flex gap-2">
            <button id="admin-btn" onclick="toggleAdmin()" class="hidden text-[10px] font-bold text-yellow-500 border border-yellow-500/20 px-4 py-2 rounded-full uppercase">Admin</button>
            <button id="login-nav" onclick="toggleModal()" class="text-[10px] font-bold text-blue-500 border border-blue-500/20 px-4 py-2 rounded-full uppercase">Login</button>
        </div>
    </nav>

    <div id="dashboard" class="hidden p-6 max-w-2xl mx-auto">
        
        <div class="bg-gradient-to-br from-blue-600 to-indigo-900 p-8 rounded-[2.5rem] shadow-2xl mb-8 text-center relative overflow-hidden">
            <p class="text-[10px] uppercase font-black text-blue-100 mb-1 tracking-widest">Available Balance</p>
            <h2 class="text-5xl font-black italic">৳<span id="user-balance">0.00</span></h2>
            <div class="flex gap-3 mt-6">
                <button onclick="showPay('Deposit')" class="flex-1 bg-white/10 py-3 rounded-xl text-[10px] font-bold uppercase">Deposit</button>
                <button onclick="showPay('Withdraw')" class="flex-1 bg-white/10 py-3 rounded-xl text-[10px] font-bold uppercase">Withdraw</button>
            </div>
        </div>

        <div id="active-pkg-area" class="hidden mb-8">
            <h3 class="text-[10px] font-black text-gray-500 uppercase mb-4 tracking-[0.2em]">Your Active Plans</h3>
            <div id="active-list" class="space-y-4"></div>
        </div>

        <div class="mb-20">
            <h3 class="text-[10px] font-black text-gray-500 uppercase mb-4 tracking-[0.2em]">Available Packages</h3>
            <div id="shop-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                </div>
        </div>

        <button onclick="logout()" class="w-full text-red-500 text-[10px] font-black uppercase tracking-widest opacity-50">Sign Out</button>
    </div>

    <div id="admin-panel" class="hidden p-6 max-w-2xl mx-auto bg-gray-900 border border-yellow-500/20 mt-6 rounded-[2.5rem] mb-20">
        <h2 class="text-yellow-500 font-black mb-6 uppercase italic">Admin Portal</h2>
        
        <div class="space-y-4 mb-10 pb-10 border-b border-gray-800">
            <p class="text-xs font-bold text-gray-400">Add New Package</p>
            <input type="text" id="adm-pname" placeholder="Package Name" class="w-full bg-black/40 p-4 rounded-xl border border-gray-800 text-sm outline-none">
            <div class="grid grid-cols-2 gap-4">
                <input type="number" id="adm-pcost" placeholder="Price (৳)" class="bg-black/40 p-4 rounded-xl border border-gray-800 text-sm outline-none">
                <input type="number" id="adm-pdaily" placeholder="Daily Profit (৳)" class="bg-black/40 p-4 rounded-xl border border-gray-800 text-sm outline-none">
            </div>
            <button onclick="addNewPackage()" class="w-full bg-blue-600 font-black py-4 rounded-xl uppercase text-xs">Publish Package</button>
        </div>

        <div class="space-y-4">
            <p class="text-xs font-bold text-gray-400">Add Money to User (Manual)</p>
            <input type="text" id="adm-uid" placeholder="User UID" class="w-full bg-black/40 p-4 rounded-xl border border-gray-800 text-sm outline-none">
            <input type="number" id="adm-amt" placeholder="Amount (৳)" class="w-full bg-black/40 p-4 rounded-xl border border-gray-800 text-sm outline-none">
            <button onclick="addMoneyAdmin()" class="w-full bg-yellow-500 text-black font-black py-4 rounded-xl uppercase text-xs">Add Balance</button>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-black/95 flex items-center justify-center p-6 hidden z-[100] backdrop-blur-md">
        <div class="glass p-8 rounded-[2.5rem] w-full max-w-sm text-center">
            <h2 class="text-2xl font-black mb-8 italic uppercase tracking-tighter text-blue-500">Investor Login</h2>
            <input type="email" id="email" placeholder="Email" class="w-full bg-black/40 p-5 rounded-2xl border border-gray-800 mb-4 outline-none">
            <input type="password" id="password" placeholder="Password" class="w-full bg-black/40 p-5 rounded-2xl border border-gray-800 mb-6 outline-none">
            <button id="login-btn" class="w-full bg-blue-600 py-5 rounded-2xl font-black uppercase tracking-widest shadow-xl shadow-blue-900/40">Authorize</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs, arrayUnion, query, where } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCFpCE8khV-aedkVyGgrZY-yDXnHU9jhb4",
            authDomain: "bd-fx-app.firebaseapp.com",
            projectId: "bd-fx-app",
            storageBucket: "bd-fx-app.firebasestorage.app",
            messagingSenderId: "943565298325",
            appId: "1:943565298325:web:329b06cd41be53c3e2999c",
            measurementId: "G-LG3XB5J7B7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const ADMIN_EMAIL = "admin@bdfx.com";

        window.toggleModal = () => document.getElementById('modal').classList.toggle('hidden');
        window.toggleAdmin = () => document.getElementById('admin-panel').classList.toggle('hidden');

        // LOGIN
        document.getElementById('login-btn').onclick = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try { await signInWithEmailAndPassword(auth, email, pass); toggleModal(); } 
            catch (e) { alert("Error: " + e.message); }
        };

        // LOAD SHOP PACKAGES
        async function loadShop() {
            const shopList = document.getElementById('shop-list');
            shopList.innerHTML = "";
            const querySnapshot = await getDocs(collection(db, "packages"));
            querySnapshot.forEach((doc) => {
                const p = doc.data();
                shopList.innerHTML += `
                    <div class="glass p-6 rounded-[2rem] pkg-card">
                        <h4 class="font-black text-lg">${p.name}</h4>
                        <p class="text-xs text-gray-400 mb-4">Earn ৳${p.daily}/day for 30 days</p>
                        <div class="flex justify-between items-center border-t border-gray-800 pt-4">
                            <span class="font-black text-blue-500">৳${p.price}</span>
                            <button onclick="buyPackage('${doc.id}', ${p.price}, ${p.daily}, '${p.name}')" class="bg-blue-600 px-5 py-2 rounded-xl text-[10px] font-black uppercase">Buy</button>
                        </div>
                    </div>`;
            });
        }

        // LOAD USER DASHBOARD
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('login-nav').classList.add('hidden');
                if(user.email === ADMIN_EMAIL) document.getElementById('admin-btn').classList.remove('hidden');
                
                await loadShop();
                await refreshUser();
            } else {
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('login-nav').classList.remove('hidden');
            }
        });

        async function refreshUser() {
            const user = auth.currentUser;
            const snap = await getDoc(doc(db, "users", user.uid));
            if (!snap.exists()) return;
            
            const data = snap.data();
            document.getElementById('user-balance').innerText = (data.balance || 0).toLocaleString();
            
            const activeList = document.getElementById('active-list');
            activeList.innerHTML = "";
            const packages = data.activePackages || [];
            
            if(packages.length > 0) {
                document.getElementById('active-pkg-area').classList.remove('hidden');
                packages.forEach((p, index) => {
                    const today = new Date().setHours(0,0,0,0);
                    const lastClaim = p.lastClaimDate ? p.lastClaimDate.toDate().setHours(0,0,0,0) : 0;
                    const canClaim = today > lastClaim;

                    activeList.innerHTML += `
                        <div class="glass p-5 rounded-2xl flex justify-between items-center border-l-4 border-blue-500">
                            <div>
                                <p class="text-[10px] font-bold text-gray-500 uppercase">${p.name}</p>
                                <p class="text-xs">Daily Profit: ৳${p.daily}</p>
                            </div>
                            <button onclick="claimProfit(${index})" ${!canClaim ? 'disabled' : ''} 
                                class="px-4 py-2 rounded-lg text-[10px] font-black uppercase ${canClaim ? 'bg-green-600' : 'bg-gray-700 text-gray-400'}">
                                ${canClaim ? 'Claim ৳' + p.daily : 'Claimed'}
                            </button>
                        </div>`;
                });
            }
        }

        // BUY PACKAGE (Subtracts from balance)
        window.buyPackage = async (id, price, daily, name) => {
            const user = auth.currentUser;
            const userRef = doc(db, "users", user.uid);
            const snap = await getDoc(userRef);
            const currentBalance = snap.data().balance || 0;

            if (currentBalance < price) return alert("Insufficient Balance! Please Deposit first.");

            if (confirm(`Purchase ${name} for ৳${price}?`)) {
                await updateDoc(userRef, {
                    balance: currentBalance - price,
                    activePackages: arrayUnion({
                        id: id,
                        name: name,
                        daily: daily,
                        purchaseDate: new Date(),
                        lastClaimDate: null
                    })
                });
                alert("Purchase Successful!");
                refreshUser();
            }
        };

        // CLAIM PROFIT
        window.claimProfit = async (index) => {
            const user = auth.currentUser;
            const userRef = doc(db, "users", user.uid);
            const snap = await getDoc(userRef);
            let data = snap.data();
            let pkgs = [...data.activePackages];
            
            pkgs[index].lastClaimDate = new Date();
            await updateDoc(userRef, {
                balance: (data.balance || 0) + pkgs[index].daily,
                activePackages: pkgs
            });
            
            alert(`৳${pkgs[index].daily} added to your balance!`);
            refreshUser();
        };

        // ADMIN: ADD PACKAGE TO SHOP
        window.addNewPackage = async () => {
            const name = document.getElementById('adm-pname').value;
            const price = Number(document.getElementById('adm-pcost').value);
            const daily = Number(document.getElementById('adm-pdaily').value);
            if(!name || !price) return;
            await setDoc(doc(collection(db, "packages")), { name, price, daily });
            alert("Package Published!");
            loadShop();
        };

        // ADMIN: ADD MONEY TO USER
        window.addMoneyAdmin = async () => {
            const uid = document.getElementById('adm-uid').value;
            const amt = Number(document.getElementById('adm-amt').value);
            const userRef = doc(db, "users", uid);
            const snap = await getDoc(userRef);
            await updateDoc(userRef, { balance: (snap.data().balance || 0) + amt });
            alert("Money Added!");
        };

        window.logout = () => signOut(auth);
    </script>
</body>
</html>